@using BlazorView.Pages.Components
@using BlazorView.Data
@using Newtonsoft.Json

@inject FetchUserFromDb UserListingService

@page "/"

<PageTitle>Index</PageTitle>

<div class="contentWrapper">
    <h1>ANGSTFRI JOBBSØKING</h1>

    <picture>
        <img src="img/LETT-5.png" class="logo" />
    </picture>
    <p>@counter</p>
    <p>@showSearch</p>
    <p>@searchValue</p>
    <EditForm Model="@searchModel" class="searchForm">
        <input type="text" placeholder="Søk her" @bind-value="searchValue" @bind-value:event="oninput" />
        <button @onclick="searchPress">Søk</button>
    </EditForm>
    <p>@loggedInUser.Name</p>
   
    @if (showSearch)
    {
        <section class="listings">
            <FetchListings SearchValue="@searchValue.ToUpper()" />
        </section>
    }
</div>


@code{
    [CascadingParameter]
    public LoggedInUserService? loggedInUser { get; set; }

    int counter;
    bool showSearch = false;

    /// <summary>
    /// Used by EditForm
    /// </summary>
    private class SearchModel
    {
        public SearchModel()
        {
        }
    }
    private SearchModel searchModel = new();

    // Value of search field
    string? searchValue = "";

    /// <summary>
    /// Method being used when search button is pressed.
    /// </summary>
    private void searchPress()
    {
        counter++;
        showSearch ^= true;
    }

    string? interestsFromDb;
    IEnumerable<Interest> interests = new List<Interest>();
    List<string> commonInterests = new List<string>();

    protected override async Task OnInitializedAsync()
    {
        interestsFromDb = await UserListingService.FetchInterest();
        interests = JsonConvert.DeserializeObject<IEnumerable<Interest>>(interestsFromDb);

        foreach (var item in interests)
        {
            if (item.userGuid == loggedInUser.Id)
            {
                commonInterests.Add(item.advertisementUuid);
            }
        }
        loggedInUser.interests = commonInterests;
    }


}