@using BlazorView.Data
@using Newtonsoft.Json

@inject FetchLocationsFromDb LocationService
@inject ILogger<ShowLocations> Logger

<section>
    @if (Locations != null)
    {
        <EditForm Model="_locationModel">
            <select @bind="SelectedLocation">
                <option value="">Velg kommune</option>
                @foreach (var Item in Locations)
                {
                    @if (!PrefferedLocations.Any(i => i.LocationId == Item.Id))
                    {
                        <option value="@Item.Id">@Item.Municipality</option>
                    }
                }
            </select>
            <button @onclick="SelectLocation">Velg kommune</button>

        </EditForm>
    }
    else
    {
        <p>Det er dessverre utfordringer med å nå Databasen som holder på lokasjoner. Vennligst prøv igjen senere.</p>

    }

    <h5>Lokasjoner lagt til:</h5>
    @if (Locations != null)
    {
        @foreach (var Item in Locations)
        {
            @if (LoggedInUserPrefferedLocations.Any(i => i.LocationId == Item.Id))
            {
                    <table>
                        <tr>
                            <td>@Item.Municipality</td>
                            <td><button @onclick="() => DeletePreferredLocation(Item)">Slett</button></td>
                        </tr>
                    </table>
     
                

            }
        }
    }
    else
    {
        <p>Det er dessverre utfordringer med å nå Databasen som holder på lokasjoner. Vennligst prøv igjen senere.</p>

    }

</section>
@code {
    [Parameter]
    public EventCallback<bool> ShowAllLocations { get; set; }


    private class LocationModel
    {

    }
    private LocationModel _locationModel = new();
    int SelectedLocation;

    // List of municipalities in Norway
    string? LocationsFromDb;
    IEnumerable<Location> Locations = new List<Location>();


    // List of municipalities marked as favorable
    string? PreferredLocationsFromDb;
    IEnumerable<PreferredLocation> PrefferedLocations = new List<PreferredLocation>();
    List<PreferredLocation> LoggedInUserPrefferedLocations = new List<PreferredLocation>();


    protected override async Task OnInitializedAsync()
    {

        // Fetch list of municipalities in Norway from db
        Logger.LogInformation("Fetching list of municipalities in Norway from Database, time: {time}", DateTimeOffset.Now);
        LocationsFromDb = await LocationService.FetchLocations();
        Locations = JsonConvert.DeserializeObject<IEnumerable<Location>>(LocationsFromDb);

        // Fetch list of preferred municipalities in Norway from db
        Logger.LogInformation("Fetching list of preferred municipalities in Norway from Database, time: {time}", DateTimeOffset.Now);
        PreferredLocationsFromDb = await LocationService.FetchPreferredLocations();
        PrefferedLocations = JsonConvert.DeserializeObject<IEnumerable<PreferredLocation>>(PreferredLocationsFromDb);

        if (PrefferedLocations != null)
        {
            foreach (var Item in PrefferedLocations)
            {
                if (Item.UserId == LoggedInUserService.Id)
                {
                    LoggedInUserPrefferedLocations.Add(Item);
                }
            }
        }

    }

    private async void SelectLocation()
    {
        PreferredLocation preferredLocation = new();
        preferredLocation.UserId = LoggedInUserService.Id;
        preferredLocation.LocationId = SelectedLocation;
        Logger.LogInformation("Saving new preferred location to Database, Location Id: {0}, User Id: {1}, Time: {time}", preferredLocation.LocationId, preferredLocation.UserId, DateTimeOffset.Now);

        LocationService.PostPreferredLocation(preferredLocation);
        PrefferedLocations.Append(preferredLocation);

        await ShowAllLocations.InvokeAsync();
    }

    private async void DeletePreferredLocation(Location location)
    {
        PreferredLocation preferredLocation = new();
        preferredLocation.LocationId = location.Id;
        preferredLocation.UserId = LoggedInUserService.Id;
        Logger.LogInformation("Deleting preferred location to Database, Location Id: {0}, User Id: {1}, Time: {time}", preferredLocation.LocationId, preferredLocation.UserId, DateTimeOffset.Now);

        LocationService.DeletePreferredLocation(preferredLocation);
        await ShowAllLocations.InvokeAsync();
    }
}

